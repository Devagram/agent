# syntax=docker/dockerfile:1

FROM python:3.11-slim

WORKDIR /app

# System deps: node + npm for building Astro projects, git, and firebase-tools
RUN apt-get update \
  && apt-get install -y --no-install-recommends curl ca-certificates git \
  && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
  && apt-get install -y --no-install-recommends nodejs \
  && npm install -g firebase-tools@13.12.0 \
  && npm cache clean --force \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/*

COPY sitegen-agent/pyproject.toml ./

RUN pip install --no-cache-dir -U pip \
  && pip install --no-cache-dir .

# Install ADK generator deps
COPY sitegen-agent/adk/package.json sitegen-agent/adk/package-lock.json* ./adk/
RUN cd adk && npm install

COPY sitegen-agent/ ./

ENV PORT=8080
EXPOSE 8080

# Cloud Run-friendly: bind to $PORT on 0.0.0.0
CMD ["python", "-m", "uvicorn", "sitegen_agent.server:app", "--host", "0.0.0.0", "--port", "8080"]
